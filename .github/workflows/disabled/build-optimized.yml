name: ğŸ”§ Optimized Build

on:
  workflow_call:
    inputs:
      frontend-changed:
        required: true
        type: string
      backend-changed:
        required: true
        type: string
      force-full:
        required: false
        type: string
        default: 'false'
    outputs:
      frontend-build-success:
        description: "Frontend build success status"
        value: ${{ jobs.frontend-build.outputs.build-success }}
      backend-build-success:
        description: "Backend build success status"
        value: ${{ jobs.backend-build.outputs.build-success }}

env:
  NODE_VERSION: '22.17.0'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸš€ Frontend Build (Optimized)
  frontend-build:
    name: ğŸš€ Frontend Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: inputs.frontend-changed == 'true' || inputs.force-full == 'true'
    outputs:
      build-success: ${{ steps.build-status.outputs.success }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js with Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: ğŸ“¦ Install Dependencies (Fast)
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit --no-fund --silent
        timeout-minutes: 2

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd frontend
          npm run build
        timeout-minutes: 2

      - name: ğŸ“Š Build Summary
        run: |
          cd frontend
          echo "ğŸ“¦ Frontend Build Summary:"
          echo "- Build Status: âœ… Success"
          echo "- Build Time: < 5 minutes"
          echo "- Artifacts: Ready for deployment"

      - name: ğŸ” Set Build Status
        id: build-status
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

  # ğŸ Backend Build (Optimized)
  backend-build:
    name: ğŸ Backend Build
    runs-on: ubuntu-latest
    timeout-minutes: 6
    if: inputs.backend-changed == 'true' || inputs.force-full == 'true'
    outputs:
      build-success: ${{ steps.build-status.outputs.success }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with Cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements*.txt'

      - name: ğŸ”§ Enhanced Dependency Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: backend-deps-v2-${{ runner.os }}-${{ hashFiles('requirements*.txt') }}
          restore-keys: |
            backend-deps-v2-${{ runner.os }}-
            backend-deps-v1-${{ runner.os }}-

      - name: ğŸ“¦ Optimized Dependency Installation
        run: |
          echo "ğŸš€ Starting optimized dependency installation..."
          
          # Upgrade pip with timeout
          python -m pip install --upgrade pip --timeout 30
          
          # Install build tools first (fast)
          pip install --timeout 30 build wheel setuptools
          
          # Use test requirements for faster installation
          if [ -f requirements-test.txt ]; then
            echo "ğŸ“¦ Installing test dependencies (faster)..."
            pip install --timeout 60 -r requirements-test.txt
          else
            echo "ğŸ“¦ Installing minimal dependencies..."
            pip install --timeout 60 fastapi pydantic pytest pytest-cov
          fi
          
          # Verify installation
          python -c "import src; print('âœ… Package imports successfully')"
        timeout-minutes: 3

      - name: ğŸ—ï¸ Build Python Package
        run: |
          echo "ğŸ—ï¸ Building Python package..."
          python -m build --wheel --no-isolation
          
          # Verify build
          if [ -d "dist" ]; then
            echo "âœ… Build successful"
            ls -la dist/
          else
            echo "âŒ Build failed"
            exit 1
          fi
        timeout-minutes: 1

      - name: ğŸ” Basic Import Test
        run: |
          echo "ğŸ§ª Testing basic imports..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          # Test core modules
          try:
              from src.database.models import DocumentModel
              from src.services.content_hash_service import ContentHashService
              print('âœ… Core modules import successfully')
          except Exception as e:
              print(f'âŒ Import test failed: {e}')
              exit(1)
          "

      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ“¦ Backend Build Summary:"
          echo "- Build Status: âœ… Success"
          echo "- Dependencies: Optimized installation"
          echo "- Build Time: < 6 minutes"
          echo "- Package: Ready for testing"

      - name: ğŸ” Set Build Status
        id: build-status
        run: |
          echo "success=true" >> $GITHUB_OUTPUT

  # ğŸ“‹ Build Summary
  build-summary:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: always()
    timeout-minutes: 1
    steps:
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "# ğŸ”§ Optimized Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ—ï¸ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Frontend Build | ${{ needs.frontend-build.result }} | ~3m |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ Backend Build | ${{ needs.backend-build.result }} | ~4m |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Calculate overall status
          frontend_status="${{ needs.frontend-build.result }}"
          backend_status="${{ needs.backend-build.result }}"
          
          if [[ "$frontend_status" == "success" || "$frontend_status" == "skipped" ]] && 
             [[ "$backend_status" == "success" || "$backend_status" == "skipped" ]]; then
            echo "âœ… **Build Status: SUCCESS**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ Optimized build completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ¯ Optimizations Applied" >> $GITHUB_STEP_SUMMARY
            echo "- Fast dependency installation with timeouts" >> $GITHUB_STEP_SUMMARY
            echo "- Enhanced caching strategy" >> $GITHUB_STEP_SUMMARY
            echo "- Minimal test dependencies for speed" >> $GITHUB_STEP_SUMMARY
            echo "- Reduced build complexity" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ Build encountered issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ¯ Build Gate Decision
        run: |
          if [[ "${{ needs.frontend-build.result }}" == "failure" || 
                "${{ needs.backend-build.result }}" == "failure" ]]; then
            echo "âŒ Build gate failed. Blocking pipeline progression."
            exit 1
          else
            echo "âœ… Build gate passed. Ready for testing phase."
          fi