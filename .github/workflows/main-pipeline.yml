name: ðŸš€ Revolutionary CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_full_pipeline:
        description: 'Force run all stages regardless of changes'
        required: false
        default: false
        type: boolean

# å…¨å±€çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '22.17.0'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '9.15.1'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# å…¨å±€å¹¶å‘æŽ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ” æ™ºèƒ½å˜æ›´æ£€æµ‹
  detect-changes:
    name: ðŸ” Smart Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      config-changed: ${{ steps.changes.outputs.config }}
      security-changed: ${{ steps.changes.outputs.security }}
      force-full: ${{ github.event.inputs.force_full_pipeline == 'true' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package*.json'
              - 'vite.config.ts'
              - 'tsconfig.json'
            backend:
              - 'src/**'
              - 'pyproject.toml'
              - 'poetry.lock'
              - 'requirements*.txt'
            docs:
              - 'docs/**'
              - '*.md'
              - 'CLAUDE.md'
            config:
              - '.github/**'
              - 'docker-compose*.yml'
              - 'Dockerfile*'
            security:
              - '.github/workflows/security-*.yml'
              - 'poetry.lock'
              - 'package-lock.json'
              - 'requirements*.txt'

  # âš¡ é˜¶æ®µ1: é—ªç”µè´¨é‡æ£€æŸ¥ (90ç§’) - ä½¿ç”¨ç»è¿‡éªŒè¯çš„ç®€åŒ–ç‰ˆæœ¬
  quality-lightning:
    name: âš¡ Quality Lightning
    needs: detect-changes
    if: |
      always() && 
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/quality-lightning-simple.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ” é˜¶æ®µ2C: å¢žå¼ºè´¨é‡åˆ†æž (8åˆ†é’Ÿ) - é‡æ–°å¯ç”¨å¢žå¼ºç‰ˆæœ¬
  quality-enhanced:
    name: ðŸ” Quality Enhanced
    needs: [detect-changes, quality-lightning]
    if: |
      always() && 
      needs.quality-lightning.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/quality-enhanced.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ”§ é˜¶æ®µ2: ä¼˜åŒ–æž„å»º (6åˆ†é’Ÿ) - é‡æ–°å¯ç”¨ä¼˜åŒ–ç‰ˆæœ¬
  build-optimized:
    name: ðŸ”§ Optimized Build
    needs: [detect-changes, quality-enhanced]
    if: |
      always() && 
      needs.quality-enhanced.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/build-optimized.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ§ª é˜¶æ®µ3: ä¼˜åŒ–æµ‹è¯• (8åˆ†é’Ÿ) - é‡æ–°å¯ç”¨ä¼˜åŒ–ç‰ˆæœ¬
  test-optimized:
    name: ðŸ§ª Optimized Testing
    needs: [detect-changes, build-optimized]
    if: |
      always() && 
      needs.build-optimized.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/test-optimized.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ”— é˜¶æ®µ4: é›†æˆéªŒè¯ (12åˆ†é’Ÿ) - é‡æ–°å¯ç”¨é›†æˆæµ‹è¯•
  integration-validation:
    name: ðŸ”— Integration Validation
    needs: [detect-changes, test-optimized]
    if: |
      always() && 
      needs.test-optimized.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/integration-validation.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ”’ é˜¶æ®µ3B: é«˜çº§å®‰å…¨æ‰«æ (12åˆ†é’Ÿ) - Phase 3Bå®žæ–½
  security-advanced:
    name: ðŸ”’ Security Advanced
    needs: [detect-changes, integration-validation]
    if: |
      always() && 
      needs.integration-validation.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.security-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/security-advanced.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ“Š é˜¶æ®µ3A: é«˜çº§æ€§èƒ½åŸºå‡†æµ‹è¯• (10åˆ†é’Ÿ) - Phase 3Aå®žæ–½
  performance-advanced:
    name: ðŸ“Š Performance Advanced
    needs: [detect-changes, integration-validation]
    if: |
      always() && 
      needs.integration-validation.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/performance-advanced.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸš€ é˜¶æ®µ3C: é«˜çº§éƒ¨ç½²è‡ªåŠ¨åŒ– (15åˆ†é’Ÿ) - Phase 3Cå®žæ–½
  deployment-advanced:
    name: ðŸš€ Deployment Advanced
    needs: [detect-changes, security-advanced, performance-advanced]
    if: |
      always() && 
      (needs.security-advanced.result == 'success' || needs.security-advanced.result == 'skipped') &&
      (needs.performance-advanced.result == 'success' || needs.performance-advanced.result == 'skipped') &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/deployment-advanced.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
      environment: 'staging'
    secrets: inherit

  # ðŸ”„ é˜¶æ®µ3D: é«˜çº§E2EéªŒè¯ (18åˆ†é’Ÿ) - Phase 3Då®žæ–½
  e2e-advanced:
    name: ðŸ”„ E2E Advanced
    needs: [detect-changes, deployment-advanced]
    if: |
      always() && 
      (needs.deployment-advanced.result == 'success' || needs.deployment-advanced.result == 'skipped') &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/e2e-advanced.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ“ˆ æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š - å®Œæ•´Phase 3ç‰ˆæœ¬
  pipeline-status:
    name: ðŸ“ˆ Pipeline Status Report
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-lightning, quality-enhanced, build-optimized, test-optimized, integration-validation, security-advanced, performance-advanced, deployment-advanced, e2e-advanced]
    if: always()
    timeout-minutes: 3
    steps:
      - name: ðŸ“Š Generate Status Report
        run: |
          echo "# ðŸš€ CI/CD Pipeline Status Report (Phase 3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration | Phase |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Change Detection | ${{ needs.detect-changes.result }} | - | Core |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Quality Lightning | ${{ needs.quality-lightning.result }} | ~30s | 1 |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Quality Enhanced | ${{ needs.quality-enhanced.result }} | ~8m | 2C |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Build (Optimized) | ${{ needs.build-optimized.result }} | ~6m | 2A |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test (Optimized) | ${{ needs.test-optimized.result }} | ~8m | 2B |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration Validation | ${{ needs.integration-validation.result }} | ~12m | 2D |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security (Advanced) | ${{ needs.security-advanced.result }} | ~12m | 3B |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Performance (Advanced) | ${{ needs.performance-advanced.result }} | ~10m | 3A |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deployment (Advanced) | ${{ needs.deployment-advanced.result }} | ~15m | 3C |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ E2E (Advanced) | ${{ needs.e2e-advanced.result }} | ~18m | 3D |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Changed: ${{ needs.detect-changes.outputs.frontend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Changed: ${{ needs.detect-changes.outputs.backend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Changed: ${{ needs.detect-changes.outputs.security-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Force Full Pipeline: ${{ needs.detect-changes.outputs.force-full }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Estimated Duration**: ~90-100 minutes (Complete Phase 3)" >> $GITHUB_STEP_SUMMARY
          echo "- **Core Pipeline**: ~35 minutes (Phase 2A-2D)" >> $GITHUB_STEP_SUMMARY
          echo "- **Advanced Analysis**: ~22 minutes (Phase 3A+3B)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment & E2E**: ~33 minutes (Phase 3C+3D)" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Execution**: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Smart Caching**: âœ… Enhanced" >> $GITHUB_STEP_SUMMARY
          echo "- **Incremental Processing**: âœ… Optimized" >> $GITHUB_STEP_SUMMARY
          
          # è®¾ç½®æ•´ä½“çŠ¶æ€ - Phase 3 æ£€æŸ¥å®Œæ•´é«˜çº§æµç¨‹
          core_success=false
          advanced_success=false
          
          # Check core pipeline (Phase 2)
          if [[ "${{ needs.quality-lightning.result }}" == "success" && 
                ("${{ needs.quality-enhanced.result }}" == "success" || "${{ needs.quality-enhanced.result }}" == "skipped") && 
                ("${{ needs.build-optimized.result }}" == "success" || "${{ needs.build-optimized.result }}" == "skipped") && 
                ("${{ needs.test-optimized.result }}" == "success" || "${{ needs.test-optimized.result }}" == "skipped") && 
                ("${{ needs.integration-validation.result }}" == "success" || "${{ needs.integration-validation.result }}" == "skipped") ]]; then
            core_success=true
          fi
          
          # Check advanced features (Phase 3A-3D)
          if [[ ("${{ needs.security-advanced.result }}" == "success" || "${{ needs.security-advanced.result }}" == "skipped") && 
                ("${{ needs.performance-advanced.result }}" == "success" || "${{ needs.performance-advanced.result }}" == "skipped") &&
                ("${{ needs.deployment-advanced.result }}" == "success" || "${{ needs.deployment-advanced.result }}" == "skipped") &&
                ("${{ needs.e2e-advanced.result }}" == "success" || "${{ needs.e2e-advanced.result }}" == "skipped") ]]; then
            advanced_success=true
          fi
          
          if [[ "$core_success" == true && "$advanced_success" == true ]]; then
            echo "âœ… **Pipeline Status: SUCCESS (Phase 3)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Phase 3 Complete**: Enterprise-grade CI/CD framework fully operational" >> $GITHUB_STEP_SUMMARY
            echo "- **Phase 2 Core**: âœ… All foundational systems operational" >> $GITHUB_STEP_SUMMARY
            echo "- **Phase 3A Performance**: âœ… Advanced monitoring & benchmarking" >> $GITHUB_STEP_SUMMARY
            echo "- **Phase 3B Security**: âœ… Multi-layer security scanning" >> $GITHUB_STEP_SUMMARY
            echo "- **Phase 3C Deployment**: âœ… Automated deployment validation" >> $GITHUB_STEP_SUMMARY
            echo "- **Phase 3D E2E**: âœ… End-to-end system validation" >> $GITHUB_STEP_SUMMARY
            echo "- **Quality Gates**: âœ… Enterprise-grade multi-tier validation" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifact Management**: âœ… Complete lifecycle management" >> $GITHUB_STEP_SUMMARY
          elif [[ "$core_success" == true ]]; then
            echo "âš ï¸ **Pipeline Status: CORE SUCCESS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Phase 2 Complete**: Core pipeline operational, advanced features may need attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Core pipeline issues detected**: Review failed stages" >> $GITHUB_STEP_SUMMARY
          fi