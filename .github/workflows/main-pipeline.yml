name: ðŸš€ Revolutionary CI/CD Pipeline

on:
  # Temporarily disabled during CI/CD simplification process
  # push:
  #   branches: [main, develop]
  # pull_request:
  #   branches: [main]
  workflow_dispatch:
    inputs:
      force_full_pipeline:
        description: 'Force run all stages regardless of changes'
        required: false
        default: false
        type: boolean

# å…¨å±€çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '22.17.0'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '9.15.1'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# å…¨å±€å¹¶å‘æŽ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ” æ™ºèƒ½å˜æ›´æ£€æµ‹
  detect-changes:
    name: ðŸ” Smart Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      config-changed: ${{ steps.changes.outputs.config }}
      security-changed: ${{ steps.changes.outputs.security }}
      force-full: ${{ github.event.inputs.force_full_pipeline == 'true' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package*.json'
              - 'vite.config.ts'
              - 'tsconfig.json'
            backend:
              - 'src/**'
              - 'pyproject.toml'
              - 'poetry.lock'
              - 'requirements*.txt'
            docs:
              - 'docs/**'
              - '*.md'
              - 'CLAUDE.md'
            config:
              - '.github/**'
              - 'docker-compose*.yml'
              - 'Dockerfile*'
            security:
              - '.github/workflows/security-*.yml'
              - 'poetry.lock'
              - 'package-lock.json'
              - 'requirements*.txt'

  # âš¡ é˜¶æ®µ1: é—ªç”µè´¨é‡æ£€æŸ¥ (90ç§’)
  quality-lightning:
    name: âš¡ Quality Lightning
    needs: detect-changes
    if: |
      always() && 
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/quality-lightning.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ”§ é˜¶æ®µ2: æ™ºèƒ½æž„å»º (2åˆ†é’Ÿ)
  build-intelligent:
    name: ðŸ”§ Intelligent Build
    needs: [detect-changes, quality-lightning]
    if: |
      always() && 
      needs.quality-lightning.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/build-intelligent.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ§ª é˜¶æ®µ3: å…¨é¢æµ‹è¯• (4åˆ†é’Ÿ)
  test-comprehensive:
    name: ðŸ§ª Comprehensive Testing
    needs: [detect-changes, build-intelligent]
    if: |
      always() && 
      needs.build-intelligent.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/test-comprehensive.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ”’ é˜¶æ®µ4: é«˜æ•ˆå®‰å…¨æ‰«æ (3åˆ†é’Ÿ)
  security-optimized:
    name: ðŸ”’ Security Optimized
    needs: [detect-changes, build-intelligent]
    if: |
      always() && 
      needs.build-intelligent.result == 'success' &&
      (needs.detect-changes.outputs.security-changed == 'true' || 
       needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/security-optimized.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ“Š é˜¶æ®µ5: æ€§èƒ½åŸºå‡†æµ‹è¯• (2åˆ†é’Ÿ)
  performance-benchmark:
    name: ðŸ“Š Performance Benchmark
    needs: [detect-changes, test-comprehensive, security-optimized]
    if: |
      always() && 
      needs.test-comprehensive.result == 'success' &&
      needs.security-optimized.result == 'success' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/performance-benchmark.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸš€ é˜¶æ®µ6: æ™ºèƒ½éƒ¨ç½² (1åˆ†é’Ÿ)
  deploy-intelligent:
    name: ðŸš€ Intelligent Deploy
    needs: [detect-changes, performance-benchmark]
    if: |
      always() && 
      needs.performance-benchmark.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.backend-changed == 'true' ||
       needs.detect-changes.outputs.force-full == 'true')
    uses: ./.github/workflows/deploy-intelligent.yml
    with:
      frontend-changed: ${{ needs.detect-changes.outputs.frontend-changed }}
      backend-changed: ${{ needs.detect-changes.outputs.backend-changed }}
      force-full: ${{ needs.detect-changes.outputs.force-full }}
    secrets: inherit

  # ðŸ“ˆ æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
  pipeline-status:
    name: ðŸ“ˆ Pipeline Status Report
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-lightning, build-intelligent, test-comprehensive, security-optimized, performance-benchmark, deploy-intelligent]
    if: always()
    timeout-minutes: 1
    steps:
      - name: ðŸ“Š Generate Status Report
        run: |
          echo "# ðŸš€ CI/CD Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Change Detection | ${{ needs.detect-changes.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Quality Lightning | ${{ needs.quality-lightning.result }} | ~90s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Intelligent Build | ${{ needs.build-intelligent.result }} | ~2m |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Comprehensive Test | ${{ needs.test-comprehensive.result }} | ~4m |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Optimized | ${{ needs.security-optimized.result }} | ~3m |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Performance Benchmark | ${{ needs.performance-benchmark.result }} | ~2m |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Intelligent Deploy | ${{ needs.deploy-intelligent.result }} | ~1m |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Changed: ${{ needs.detect-changes.outputs.frontend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Changed: ${{ needs.detect-changes.outputs.backend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Changed: ${{ needs.detect-changes.outputs.security-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Force Full Pipeline: ${{ needs.detect-changes.outputs.force-full }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total Estimated Duration: ~12-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel Execution: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Smart Caching: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Incremental Processing: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          
          # è®¾ç½®æ•´ä½“çŠ¶æ€
          if [[ "${{ needs.quality-lightning.result }}" == "success" && 
                "${{ needs.build-intelligent.result }}" == "success" && 
                "${{ needs.test-comprehensive.result }}" == "success" && 
                "${{ needs.security-optimized.result }}" == "success" && 
                "${{ needs.performance-benchmark.result }}" == "success" ]]; then
            echo "âœ… **Pipeline Status: SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline Status: FAILED**" >> $GITHUB_STEP_SUMMARY
          fi